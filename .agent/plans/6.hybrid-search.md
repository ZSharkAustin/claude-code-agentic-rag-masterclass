# Module 6: Hybrid Search

⚠️ **Medium** - New SQL function with RRF logic, schema migration, minimal Python changes

## Summary

Add full-text keyword search alongside existing vector search using Postgres native tsvector/tsquery. Combine results via Reciprocal Rank Fusion (RRF). The tsvector column is auto-generated by Postgres, so the document processing pipeline needs zero changes.

## How RRF Works

```
rrf_score = 1/(k + rank_vector) + 1/(k + rank_fts)
```

- `rank_vector` / `rank_fts` = 1-based position in each result set
- `k = 60` (smoothing constant)
- Chunks found by only one method get a penalty rank (`candidate_count + 1`)
- No score normalization needed — operates on rank positions only

## Files Modified

| File | Changes |
|------|---------|
| `backend/supabase/migrations/005_hybrid_search.sql` | **New** — tsvector column, GIN index, `match_chunks_hybrid` function |
| `backend/app/routers/chat.py` | 2-line change: add `query_text` param, switch RPC to `match_chunks_hybrid` |
| `backend/app/services/document_service.py` | **No changes** — generated column handles tsvector automatically |
| `PROGRESS.md` | Add Module 6 section |

---

## Phase 1: SQL Migration

### 1.1 Create `backend/supabase/migrations/005_hybrid_search.sql`

Three parts:

**A) Add stored generated tsvector column to chunks:**
```sql
alter table public.chunks
    add column if not exists fts tsvector
    generated always as (to_tsvector('english', content)) stored;
```
- Auto-computed from `content` on every INSERT/UPDATE
- Backfills all existing rows automatically
- Cannot be written to directly (Postgres rejects it)

**B) GIN index for full-text search:**
```sql
create index if not exists idx_chunks_fts on public.chunks using gin (fts);
```

**C) `match_chunks_hybrid` function:**
- Same signature as `match_chunks` plus `query_text text`, `rrf_k integer default 60`, `candidate_count integer default 30`
- Returns same columns plus `rrf_score float`
- Uses `SECURITY DEFINER` (same pattern as existing function)
- Three CTEs:
  1. `vector_results` — top N by embedding distance (same as current `match_chunks`)
  2. `fts_results` — top N by `ts_rank` where `fts @@ websearch_to_tsquery('english', query_text)`
  3. `combined` — FULL OUTER JOIN + RRF scoring
- `websearch_to_tsquery` chosen over `plainto_tsquery` for natural query syntax support
- Existing `match_chunks` function is NOT removed (kept as fallback)

**Validate:** Run migration, then verify:
- `fts` column exists on chunks table
- All existing chunks have non-null `fts` values
- `match_chunks_hybrid` function exists and is callable

---

## Phase 2: Update Search Execution

### 2.1 Update `_execute_search()` in `backend/app/routers/chat.py`

Two changes only:

1. Add `"query_text": query` to the `rpc_params` dict
2. Change `"match_chunks"` → `"match_chunks_hybrid"` in the RPC call

Response format is identical — same columns (`id`, `document_id`, `content`, `chunk_index`, `metadata`, `similarity`) plus `rrf_score` which the formatting code ignores.

**Validate:** Upload a document, chat with a question, verify search results appear in response.

---

## Phase 3: Update Progress

### 3.1 Update PROGRESS.md
Add Module 6 section with completed tasks.

---

## Validation

1. **Migration:** Run against Supabase, verify column/index/function exist
2. **Backfill:** Confirm all existing chunks have non-null `fts` values
3. **New uploads:** Upload a document, verify it reaches "ready" (no insert errors from generated column)
4. **Keyword advantage:** Upload a doc with a unique term, search for that exact term — hybrid should rank it high
5. **Semantic fallback:** Search with a paraphrased query that doesn't match exact keywords — vector component still finds relevant chunks
6. **Old function:** Verify `match_chunks` still callable (not removed)
7. **LangSmith:** Check traces show `match_chunks_hybrid` being called

## Risks

- **English hardcoded:** `to_tsvector('english', ...)` assumes English. Use `'simple'` config if multi-language needed later
- **Migration on large tables:** Generated stored column triggers table rewrite. Fine for this project scale
- **`websearch_to_tsquery` edge cases:** Robust with most input, but unusual syntax could cause issues. Falls back gracefully since FTS CTE simply returns no rows
